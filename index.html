<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Translator & Explainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
     <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        .fira-code {
            font-family: 'Fira Code', monospace;
        }
        .glass-panel {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-primary {
            background-color: #4f46e5;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #374151;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #4338ca; }
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .explanation-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid #4f46e5;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
        }
        .code-line {
            font-family: 'Fira Code', monospace;
            background-color: #111827;
            padding: 0.75rem;
            border-radius: 0.375rem;
            color: #a5b4fc;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.875rem;
        }
        .explanation-text {
            color: #d1d5db;
            padding-left: 0.25rem;
            font-size: 0.95rem;
        }
        /* --- UPDATED STYLES FOR BUTTONS --- */
        .editor-buttons {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        .util-btn {
            background-color: rgba(31, 41, 55, 0.7);
            color: #9ca3af;
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .util-btn:hover {
            background-color: #4b5563;
            color: #e5e7eb;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white">AI Code Translator & Explainer</h1>
          
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Panel -->
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Source Code</h2>
                    <select id="source-lang" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option>JavaScript</option><option>Python</option><option>Java</option><option>C++</option><option>Go</option><option>Rust</option><option>TypeScript</option><option>PHP</option>
                    </select>
                </div>
                <div class="relative w-full h-80">
                    <textarea id="source-code" class="fira-code w-full h-full bg-gray-900/80 border border-gray-700 rounded-lg p-4 text-sm resize-none focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Paste your code here..."></textarea>
                    <!-- UPDATED: Button container -->
                    <div class="editor-buttons">
                        <button id="copy-source-btn" class="util-btn" title="Copy code">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                        <button id="download-source-btn" class="util-btn" title="Download code">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Translated Code</h2>
                    <select id="target-lang" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option>Python</option><option>JavaScript</option><option>Go</option><option>Rust</option><option>Java</option><option>C++</option><option>TypeScript</option><option>PHP</option>
                    </select>
                </div>
                <div class="relative w-full h-80">
                    <textarea id="translated-code" readonly class="fira-code w-full h-full bg-gray-900/80 border border-gray-700 rounded-lg p-4 text-sm resize-none"></textarea>
                    <!-- UPDATED: Button container -->
                    <div class="editor-buttons">
                        <button id="copy-translated-btn" class="util-btn" title="Copy code">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                         <button id="download-translated-btn" class="util-btn" title="Download code">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                    </div>
                    <div id="output-loader" class="absolute inset-0 bg-gray-900/50 flex justify-center items-center rounded-lg hidden"><div class="spinner"></div></div>
                </div>
            </div>
        </main>

        <div class="flex justify-center items-center gap-4 my-6">
            <button id="translate-btn" class="btn-primary font-semibold text-white px-8 py-3 rounded-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                Translate
            </button>
            <button id="explain-btn" class="btn-secondary font-semibold text-white px-8 py-3 rounded-lg hidden items-center gap-2">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12" y1="8" y2="8"/><circle cx="12" cy="12" r="10"/><path d="m12 12 4 4"/></svg>
                Explain Code
            </button>
        </div>
        
        <div id="explanation-container" class="glass-panel p-6 rounded-2xl mt-8 hidden">
             <h2 class="text-2xl font-semibold text-white mb-4 text-center">Code Explanation</h2>
             <div id="explanation-content" class="text-gray-300"></div>
             <div id="explanation-loader" class="w-full flex justify-center items-center p-8 hidden"><div class="spinner"></div></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sourceCodeEl = document.getElementById('source-code');
            const translatedCodeEl = document.getElementById('translated-code');
            const sourceLangEl = document.getElementById('source-lang');
            const targetLangEl = document.getElementById('target-lang');
            const translateBtn = document.getElementById('translate-btn');
            const explainBtn = document.getElementById('explain-btn');
            const explanationContainer = document.getElementById('explanation-container');
            const explanationContent = document.getElementById('explanation-content');
            const outputLoader = document.getElementById('output-loader');
            const explanationLoader = document.getElementById('explanation-loader');
            const copySourceBtn = document.getElementById('copy-source-btn');
            const copyTranslatedBtn = document.getElementById('copy-translated-btn');
            // NEW: Get download buttons
            const downloadSourceBtn = document.getElementById('download-source-btn');
            const downloadTranslatedBtn = document.getElementById('download-translated-btn');

            const API_URL = new URL('/api/generate', window.location.origin).toString();
            
            async function callBackendAPI(prompt, task, loader) {
                loader.classList.remove('hidden');
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: prompt, task: task })
                    });
                    const contentType = response.headers.get("content-type");
                    if (!response.ok || !contentType || !contentType.includes("application/json")) {
                        const textError = await response.text();
                        console.error("Server Error Response:", textError);
                        throw new Error("Server returned an invalid response. This often means the backend function has an error.");
                    }
                    const result = await response.json();
                    if (result.error) { throw new Error(result.error); }
                    return result.result;
                } catch (error) {
                    console.error(`API call failed:`, error);
                    if (error instanceof SyntaxError) { return "Error: Failed to parse server response. The backend is likely misconfigured or down."; }
                    return `Error: ${error.message}`;
                } finally {
                    loader.classList.add('hidden');
                }
            }

            translateBtn.addEventListener('click', async () => {
                const sourceCode = sourceCodeEl.value.trim();
                const sourceLang = sourceLangEl.value;
                const targetLang = targetLangEl.value;
                if (!sourceCode) {
                    translatedCodeEl.value = "Please enter some code to translate.";
                    return;
                }
                translatedCodeEl.value = '';
                explanationContainer.classList.add('hidden');
                explainBtn.classList.add('hidden');
                const translatePrompt = `Translate the following ${sourceLang} code to ${targetLang}:\n\n${sourceCode}`;
                const translatedCode = await callBackendAPI(translatePrompt, 'translate', outputLoader);
                translatedCodeEl.value = translatedCode;
                if (!translatedCode.startsWith("Error:")) {
                    explainBtn.classList.remove('hidden');
                }
            });

            explainBtn.addEventListener('click', async () => {
                const translatedCode = translatedCodeEl.value.trim();
                const targetLang = targetLangEl.value;
                if (!translatedCode || translatedCode.startsWith("Error:")) {
                    explanationContent.innerHTML = "<p>There is no valid code to explain.</p>";
                    explanationContainer.classList.remove('hidden');
                    return;
                }
                explanationContainer.classList.remove('hidden');
                explanationContent.innerHTML = '';
                const explainPrompt = `Here is the ${targetLang} code to explain:\n\n${translatedCode}`;
                const explanation = await callBackendAPI(explainPrompt, 'explain', explanationLoader);
                explanationContent.innerHTML = explanation;
            });

            function setupCopyButton(button, textarea) {
                const originalContent = button.innerHTML;
                button.addEventListener('click', () => {
                    const textToCopy = textarea.value;
                    if (!textToCopy) return;

                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = textToCopy;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    try {
                        document.execCommand('copy');
                        button.innerHTML = 'Copied!';
                        setTimeout(() => {
                            button.innerHTML = originalContent;
                        }, 2000);
                    } catch (err) {
                        console.error('Fallback copy failed', err);
                        button.innerHTML = 'Failed!';
                         setTimeout(() => {
                            button.innerHTML = originalContent;
                        }, 2000);
                    }
                    document.body.removeChild(tempTextarea);
                });
            }

            // --- NEW: LOGIC FOR DOWNLOAD BUTTONS ---
            function setupDownloadButton(button, textarea, langDropdown) {
                const langExtensionMap = {
                    'JavaScript': 'js', 'Python': 'py', 'Java': 'java', 'C++': 'cpp', 'Go': 'go', 'Rust': 'rs', 'TypeScript': 'ts', 'PHP': 'php'
                };

                button.addEventListener('click', () => {
                    const textToDownload = textarea.value;
                    if (!textToDownload) return;

                    const lang = langDropdown.value;
                    const extension = langExtensionMap[lang] || 'txt';
                    const filename = `code.${extension}`;
                    
                    const blob = new Blob([textToDownload], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }

            setupCopyButton(copySourceBtn, sourceCodeEl);
            setupCopyButton(copyTranslatedBtn, translatedCodeEl);
            setupDownloadButton(downloadSourceBtn, sourceCodeEl, sourceLangEl);
            setupDownloadButton(downloadTranslatedBtn, translatedCodeEl, targetLangEl);
        });
    </script>
</body>
</html>

